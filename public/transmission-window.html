<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transmission Window</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: Arial, sans-serif;
        }
        .video-container {
            position: relative;
            width: 90vw;
            height: 90vh;
            background: #111;
            border: 2px solid #333;
            border-radius: 8px;
            overflow: hidden;
        }
        .video-element {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
        }
        .status {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
        }
        .debug {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: #0f0;
            background: rgba(0,0,0,0.8);
            padding: 8px;
            border-radius: 4px;
            font-size: 10px;
            max-width: 300px;
        }
    </style>
</head>
<body>
    <div class="video-container">
        <video id="participantVideo" class="video-element" autoplay playsinline muted></video>
        <div class="status" id="status">Aguardando stream...</div>
        <div class="debug" id="debug">Debug: Inicializado</div>
    </div>

    <script>
        const video = document.getElementById('participantVideo');
        const status = document.getElementById('status');
        const debug = document.getElementById('debug');
        
        let currentParticipant = null;
        let currentStream = null;

        function updateDebug(message) {
            const timestamp = new Date().toLocaleTimeString();
            debug.textContent = `[${timestamp}] ${message}`;
            console.log(`üé¨ POPUP DEBUG: ${message}`);
        }

        function updateStatus(message) {
            status.textContent = message;
            updateDebug(`Status: ${message}`);
        }

        // FASE 2: Fun√ß√£o para buscar stream do host
        function getStreamFromHost(participantId) {
            try {
                console.log(`[POPUP-REQUEST] window.opener.getParticipantStream(${participantId})`);
                
                if (!window.opener) {
                    updateDebug('‚ùå window.opener n√£o dispon√≠vel');
                    return null;
                }
                
                if (typeof window.opener.getParticipantStream !== 'function') {
                    updateDebug('‚ùå window.opener.getParticipantStream n√£o √© fun√ß√£o');
                    return null;
                }
                
                const stream = window.opener.getParticipantStream(participantId);
                console.log(`[POPUP-REQUEST] result participantId=${participantId} found=${!!stream}`);
                
                if (stream) {
                    updateDebug(`‚úÖ Stream encontrado no host para ${participantId} - streamId=${stream.id} tracks=${stream.getTracks().length}`);
                    return stream;
                } else {
                    updateDebug(`‚ùå Stream n√£o encontrado no host para ${participantId}`);
                    return null;
                }
            } catch (error) {
                updateDebug(`‚ùå Erro ao buscar stream: ${error.message}`);
                console.error(`[POPUP-REQUEST] error:`, error);
                return null;
            }
        }

        // FASE 2: Atribuir stream ao v√≠deo
        function assignStreamToVideo(participantId, stream) {
            try {
                if (!stream || !stream.getTracks().length) {
                    throw new Error('Stream inv√°lido');
                }

                video.srcObject = stream;
                currentStream = stream;
                currentParticipant = participantId;
                
                console.log(`[POPUP-ASSIGN] video.srcObject=stream participantId=${participantId} streamId=${stream.id}`);
                updateStatus(`Reproduzindo: ${participantId}`);
                updateDebug(`‚úÖ CRITICAL SUCCESS: Remote stream assigned para ${participantId}`);
                
                // Verificar se o v√≠deo est√° reproduzindo
                video.addEventListener('loadedmetadata', () => {
                    updateDebug(`V√≠deo metadata carregado - ${video.videoWidth}x${video.videoHeight}`);
                });
                
                video.addEventListener('playing', () => {
                    updateDebug(`‚úÖ V√≠deo reproduzindo corretamente`);
                });
                
                video.addEventListener('error', (e) => {
                    updateDebug(`‚ùå Erro no v√≠deo: ${e.message}`);
                });

            } catch (error) {
                updateDebug(`‚ùå Erro ao atribuir stream: ${error.message}`);
                updateStatus(`Erro: ${error.message}`);
            }
        }

        // Listener para mensagens do host
        window.addEventListener('message', (event) => {
            try {
                console.log(`[POPUP-BRIDGE] received message:`, event.data);
                
                // Valida√ß√£o melhorada para evitar "undefined"
                if (!event.data || typeof event.data !== 'object') {
                    updateDebug(`‚ùå Mensagem inv√°lida recebida (n√£o √© objeto)`);
                    return;
                }
                
                const { type, participantId, sessionId } = event.data;
                
                if (!type) {
                    updateDebug(`‚ùå Mensagem sem type`);
                    return;
                }
                
                updateDebug(`Mensagem v√°lida: ${type} para ${participantId || 'N/A'}`);

                // FASE 2: Responder ao participant-stream-ready
                if (type === 'participant-stream-ready' && participantId) {
                    updateDebug(`Processando stream-ready para ${participantId}`);
                    
                    // Buscar o stream real do host
                    const stream = getStreamFromHost(participantId);
                    
                    if (stream) {
                        assignStreamToVideo(participantId, stream);
                    } else {
                        updateStatus(`Stream n√£o dispon√≠vel para ${participantId}`);
                        updateDebug(`‚ùå Stream n√£o encontrado para ${participantId}`);
                    }
                }
                
                // Responder a transmission-ready do host
                else if (type === 'transmission-ready' && sessionId) {
                    updateDebug(`Host pronto para sess√£o: ${sessionId}`);
                }

            } catch (error) {
                updateDebug(`‚ùå Erro ao processar mensagem: ${error.message}`);
            }
        });

        // Inicializa√ß√£o com handshake
        function initializePopup() {
            updateDebug('Popup inicializada');
            updateStatus('Conectado - Aguardando participantes');
            
            // Enviar sinal de que popup est√° pronta
            if (window.opener) {
                try {
                    const sessionId = new URLSearchParams(window.location.search).get('sessionId') || 'unknown';
                    window.opener.postMessage({
                        type: 'transmission-ready',
                        sessionId: sessionId
                    }, '*');
                    updateDebug(`Handshake enviado para host: sessionId=${sessionId}`);
                } catch (error) {
                    updateDebug(`‚ùå Erro no handshake: ${error.message}`);
                }
            }
        }
        
        // Inicializar
        initializePopup();

    </script>
</body>
</html>